<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #0b1021;
        color: #e7edf7;
        margin: 0;
        padding: 24px;
      }
      h1 {
        margin-top: 0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
      .card {
        background: #11162b;
        border: 1px solid #1b2540;
        border-radius: 10px;
        padding: 14px;
      }
      .card p.hint {
        font-size: 13px;
        color: #9aa5ce;
        margin-top: 10px;
      }
      button {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #1b2540;
        background: #19233d;
        color: #e7edf7;
        cursor: pointer;
      }
      button:hover {
        border-color: #5ef2d6;
        color: #5ef2d6;
      }
      .notify-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }
      .notify-actions button {
        flex: 1 1 30%;
        min-width: 120px;
      }
      pre {
        background: #0d1225;
        padding: 10px;
        border-radius: 8px;
        max-height: 200px;
        overflow: auto;
        color: #c0caf5;
      }
      video {
        width: 100%;
        max-height: 220px;
        background: #000;
      }
      .ghost {
        margin-left: 8px;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <h1>Local API Test</h1>
    <div class="grid">
      <div class="card">
        <h3>Notification</h3>
        <button id="notify">Request + Show</button>
      </div>
      <div class="card">
        <h3>Notification Adapters</h3>
        <p>Gửi payload thử cho từng delivery mode của service <code>local-test</code>.</p>
        <div class="notify-actions">
          <button id="notify-webpush">WebPush</button>
          <button id="notify-realtime">Realtime</button>
          <button id="notify-fcm">FCM Native</button>
        </div>
        <p class="hint" id="notify-status">Chưa chạy bài test nào.</p>
      </div>
      <div class="card">
        <h3>Microphone</h3>
        <button id="mic">Open Mic</button>
        <audio id="mic-audio" controls></audio>
      </div>
      <div class="card">
        <h3>Camera</h3>
        <button id="cam">Open Camera</button>
        <video id="cam-video" autoplay muted playsinline></video>
      </div>
      <div class="card">
        <h3>Screen Capture</h3>
        <button id="screen">Share Screen</button>
        <video id="screen-video" autoplay muted playsinline></video>
      </div>
      <div class="card">
        <h3>Fullscreen</h3>
        <button id="enter-fullscreen">Enter fullscreen</button>
        <button id="exit-fullscreen" class="ghost">Exit fullscreen</button>
      </div>
    </div>
    <div class="card" style="margin-top: 16px">
      <h3>Log</h3>
      <pre id="log"></pre>
    </div>

    <script src="../notifications.js"></script>
    <script>
      const log = (msg) => {
        const pre = document.getElementById("log");
        pre.textContent += msg + "\n";
        pre.scrollTop = pre.scrollHeight;
      };

      const serviceUnderTest = "local-test";
      const adapterStatus = document.getElementById("notify-status");

      const setAdapterStatus = (text, ok = true) => {
        adapterStatus.textContent = text;
        adapterStatus.style.color = ok ? "#9aa5ce" : "#f7768e";
      };

      if (window.notificationHub) {
        window.notificationHub
          .configure([
            {
              id: serviceUnderTest,
              name: "Local API Test",
              deliveryMode: "realtime",
              fallbackMode: "webpush",
              deliveryConfig: {
                realtime: {
                  wsUrl: "ws://localhost:8787/notifications",
                  sseUrl: ""
                },
                webpush: {
                  vapidPublicKey: "",
                  subscribeUrl: "http://localhost:8787/subscribe",
                  serviceWorkerPath: "../sw.js"
                },
                fcmNative: {
                  senderId: "",
                  credentialsPath: ""
                }
              }
            }
          ])
          .then(() => log(`[notify] Hub đã sẵn sàng cho ${serviceUnderTest}`))
          .catch((err) => log(`[notify] Hub lỗi: ${err}`));
      }

      const testAdapter = async (mode) => {
        const hub = window.notificationHub;
        const timestamp = new Date().toLocaleTimeString();
        if (!hub) {
          const msg = `[${timestamp}] Hub chưa sẵn sàng, không thể test ${mode}.`;
          log(msg);
          setAdapterStatus(msg, false);
          return;
        }
        const payload = {
          title: `${mode} test @ ${timestamp}`,
          body: `Ping ${mode} từ local-test`,
          data: { serviceId: serviceUnderTest, issuedAt: Date.now(), mode }
        };
        setAdapterStatus(`Đang gửi ${mode}...`);
        try {
          let res;
          if (typeof hub.notifyViaMode === "function") {
            res = await hub.notifyViaMode(serviceUnderTest, mode, payload);
          } else {
            res = await hub.notify(serviceUnderTest, payload);
          }
          const ok = !!res?.ok;
          const msg = `[${timestamp}] ${mode} => ${ok ? "OK" : "FAIL"} ${res?.reason || ""}`.trim();
          log(msg);
          setAdapterStatus(msg, ok);
        } catch (err) {
          const errMsg = `[${timestamp}] ${mode} lỗi: ${err}`;
          log(errMsg);
          setAdapterStatus(errMsg, false);
        }
      };

      document.getElementById("notify").onclick = async () => {
        try {
          const perm = await Notification.requestPermission();
          log("Notification permission: " + perm);
          if (perm === "granted") {
            new Notification("Local Test", { body: "Hello from local test page" });
            log("Notification shown");
          }
        } catch (err) {
          log("Notification error: " + err);
        }
      };

      document.getElementById("notify-webpush").onclick = () => testAdapter("webpush");
      document.getElementById("notify-realtime").onclick = () => testAdapter("realtime");
      document.getElementById("notify-fcm").onclick = () => testAdapter("fcm-native");

      document.getElementById("mic").onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          document.getElementById("mic-audio").srcObject = stream;
          document.getElementById("mic-audio").play();
          log("Mic stream started");
        } catch (err) {
          log("Mic error: " + err);
        }
      };

      document.getElementById("cam").onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          const video = document.getElementById("cam-video");
          video.srcObject = stream;
          video.play();
          log("Camera stream started");
        } catch (err) {
          log("Camera error: " + err);
        }
      };

      document.getElementById("screen").onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
          const video = document.getElementById("screen-video");
          video.srcObject = stream;
          video.play();
          log("Screen capture started");
        } catch (err) {
          log("Screen error: " + err);
        }
      };

      const enterBtn = document.getElementById("enter-fullscreen");
      const exitBtn = document.getElementById("exit-fullscreen");
      const updateFsButtons = () => {
        const isFs = !!document.fullscreenElement;
        enterBtn.style.display = isFs ? "none" : "inline-block";
        exitBtn.style.display = isFs ? "inline-block" : "none";
      };
      updateFsButtons();

      document.addEventListener("fullscreenchange", updateFsButtons);

      enterBtn.onclick = async () => {
        try {
          await document.documentElement.requestFullscreen();
          log("Entered fullscreen");
        } catch (err) {
          log("Fullscreen error: " + err);
        }
      };

      exitBtn.onclick = async () => {
        try {
          await document.exitFullscreen();
          log("Exited fullscreen");
        } catch (err) {
          log("Exit fullscreen error: " + err);
        }
      };

      window.addEventListener("realtime:message", (event) => {
        const detail = event.detail || {};
        log(`[Realtime] ${JSON.stringify(detail)}`);
      });

      window.addEventListener("webpush:message", (event) => {
        const detail = event.detail || {};
        log(`[WebPush] ${JSON.stringify(detail)}`);
      });
    </script>
  </body>
 </html>
